<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â›³ AI ã‚´ãƒ«ãƒ•ã‚¢ãƒ‰ãƒ¬ã‚¹è¨ºæ–­ãƒ„ãƒ¼ãƒ« - MediaPipeç‰ˆ</title>
    
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .header .badge {
            display: inline-block;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .left-panel, .right-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-section {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 25px;
            background: #f8faff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: #5a6fd8;
            background: #f0f8ff;
        }

        .upload-section.drag-over {
            border-color: #28a745;
            background: #f0fff4;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3);
        }

        .camera-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        #file-input {
            display: none;
        }

        .settings-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
        }

        .setting-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
            font-size: 0.9em;
        }

        .setting-group select {
            padding: 8px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
        }

        .canvas-container {
            position: relative;
            text-align: center;
            margin-bottom: 20px;
        }

        .main-canvas {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .overlay-canvas {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none;
        }

        .video-container {
            display: none;
            text-align: center;
            margin-bottom: 20px;
        }

        .video-element {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .action-panel {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .action-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .action-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .clear-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .results-section {
            margin-top: 30px;
        }

        .score-display {
            text-align: center;
            margin-bottom: 30px;
        }

        .score-circle {
            display: inline-block;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            font-weight: bold;
            margin: 15px auto;
            position: relative;
        }

        .score-circle::after {
            content: 'ç‚¹';
            font-size: 0.4em;
            position: absolute;
            bottom: 25px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .chart-canvas {
            max-height: 400px;
        }

        .evaluation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .evaluation-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .evaluation-item:hover {
            transform: translateY(-2px);
        }

        .evaluation-score {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .score-excellent { color: #28a745; }
        .score-good { color: #ffc107; }
        .score-poor { color: #dc3545; }

        .status-message {
            text-align: center;
            padding: 12px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-info { background: #d1ecf1; color: #0c5460; }
        .status-warning { background: #fff3cd; color: #856404; }

        .pose-landmarks {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .feature-badge {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 5px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container { 
                padding: 20px; 
                margin: 10px; 
            }
            .upload-section { 
                padding: 30px 15px; 
            }
            .settings-panel { 
                grid-template-columns: 1fr; 
            }
            .evaluation-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>â›³ AI ã‚´ãƒ«ãƒ•ã‚¢ãƒ‰ãƒ¬ã‚¹è¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
            <p class="subtitle">MediaPipe AIæŠ€è¡“ã«ã‚ˆã‚‹é«˜ç²¾åº¦å§¿å‹¢è§£æ</p>
            <span class="badge">ğŸ¤– MediaPipe Powered</span>
            <span class="badge">ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è§£æ</span>
        </div>

        <div class="main-grid">
            <!-- å·¦ãƒ‘ãƒãƒ«: ç”»åƒ/å‹•ç”»å…¥åŠ› -->
            <div class="left-panel">
                <div class="section-title">
                    <span>ğŸ“·</span> ç”»åƒãƒ»ã‚«ãƒ¡ãƒ©å…¥åŠ›
                </div>

                <div class="upload-section" id="upload-section">
                    <input type="file" id="file-input" accept="image/*">
                    <button class="upload-btn" onclick="uploadImage()">
                        ğŸ“ ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </button>
                    <button class="upload-btn camera-btn" onclick="startCamera()">
                        ğŸ“¹ ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
                    </button>
                    <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                        ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯ã‚«ãƒ¡ãƒ©ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ºæ–­
                    </p>
                </div>

                <div id="status-message"></div>

                <div class="settings-panel">
                    <div class="setting-group">
                        <label for="handedness">åˆ©ãæ‰‹</label>
                        <select id="handedness">
                            <option value="right">å³æ‰“ã¡</option>
                            <option value="left">å·¦æ‰“ã¡</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label for="shooting-direction">æ’®å½±æ–¹å‘</label>
                        <select id="shooting-direction">
                            <option value="front">æ­£é¢</option>
                            <option value="rear">å¾Œæ–¹</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label for="club-type">ä½¿ç”¨ã‚¯ãƒ©ãƒ–</label>
                        <select id="club-type">
                            <option value="Driver">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</option>
                            <option value="3W">3ç•ªã‚¦ãƒƒãƒ‰</option>
                            <option value="7I">7ç•ªã‚¢ã‚¤ã‚¢ãƒ³</option>
                            <option value="PW">ãƒ”ãƒƒãƒãƒ³ã‚°</option>
                            <option value="SW">ã‚µãƒ³ãƒ‰</option>
                        </select>
                    </div>
                </div>

                <!-- ç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="canvas-container" id="canvas-container" style="display: none;">
                    <canvas id="main-canvas" class="main-canvas"></canvas>
                    <canvas id="overlay-canvas" class="overlay-canvas"></canvas>
                </div>

                <!-- ãƒ“ãƒ‡ã‚ªè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="video-container" id="video-container">
                    <video id="video-element" class="video-element" autoplay playsinline></video>
                    <canvas id="video-canvas" style="display: none;"></canvas>
                </div>

                <div class="action-panel">
                    <button class="action-btn" id="analyze-btn" onclick="analyzeImage()" disabled>
                        ğŸ¤– AIè¨ºæ–­é–‹å§‹
                    </button>
                    <button class="action-btn" id="capture-btn" onclick="captureFrame()" style="display: none;">
                        ğŸ“¸ ãƒ•ãƒ¬ãƒ¼ãƒ å–å¾—
                    </button>
                    <button class="action-btn clear-btn" onclick="clearAll()">
                        ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                    </button>
                </div>

                <div class="progress-bar" id="progress-bar" style="display: none;">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>

            <!-- å³ãƒ‘ãƒãƒ«: çµæœè¡¨ç¤º -->
            <div class="right-panel">
                <div class="section-title">
                    <span>ğŸ“Š</span> è¨ºæ–­çµæœ
                    <span class="feature-badge">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ </span>
                </div>

                <div class="score-display">
                    <div class="score-circle">
                        <span id="total-score">--</span>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <span id="score-status" style="font-weight: bold; color: #666;">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</span>
                    </div>
                </div>

                <!-- ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ -->
                <div class="chart-container">
                    <h3 style="text-align: center; margin-bottom: 20px; color: #333;">
                        ğŸ“ˆ ç·åˆè©•ä¾¡ãƒãƒ£ãƒ¼ãƒˆ
                    </h3>
                    <canvas id="radar-chart" class="chart-canvas"></canvas>
                </div>

                <!-- è©•ä¾¡è©³ç´° -->
                <div class="evaluation-grid" id="evaluation-results">
                    <div class="evaluation-item">
                        <h4>ãƒœãƒ¼ãƒ«ä½ç½®</h4>
                        <div class="evaluation-score score-excellent">--ç‚¹</div>
                        <p>ç”»åƒã‚’è§£æã—ã¦ãã ã•ã„</p>
                    </div>
                    <div class="evaluation-item">
                        <h4>ã‚¹ã‚¿ãƒ³ã‚¹å¹…</h4>
                        <div class="evaluation-score score-excellent">--ç‚¹</div>
                        <p>ç”»åƒã‚’è§£æã—ã¦ãã ã•ã„</p>
                    </div>
                    <div class="evaluation-item">
                        <h4>å§¿å‹¢ãƒãƒ©ãƒ³ã‚¹</h4>
                        <div class="evaluation-score score-excellent">--ç‚¹</div>
                        <p>ç”»åƒã‚’è§£æã—ã¦ãã ã•ã„</p>
                    </div>
                    <div class="evaluation-item">
                        <h4>ä½“ã®å‘ã</h4>
                        <div class="evaluation-score score-excellent">--ç‚¹</div>
                        <p>ç”»åƒã‚’è§£æã—ã¦ãã ã•ã„</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentImage = null;
        let pose = null;
        let camera = null;
        let isProcessing = false;
        let radarChart = null;
        let currentPose = null;
        let isCamera = false;

        // MediaPipe PoseåˆæœŸåŒ–
        function initializeMediaPipe() {
            pose = new Pose({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
                }
            });

            pose.setOptions({
                modelComplexity: 1,
                smoothLandmarks: true,
                enableSegmentation: false,
                smoothSegmentation: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            pose.onResults(onResults);
            showStatus('âœ… MediaPipe AI ã‚¨ãƒ³ã‚¸ãƒ³ãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ', 'success');
        }

        // MediaPipeçµæœå‡¦ç†
        function onResults(results) {
            if (!isProcessing) return;

            const canvasElement = document.getElementById('main-canvas');
            const overlayCanvas = document.getElementById('overlay-canvas');
            
            if (!canvasElement || !overlayCanvas) return;

            const canvasCtx = overlayCanvas.getContext('2d');
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’åŒæœŸ
            overlayCanvas.width = canvasElement.width;
            overlayCanvas.height = canvasElement.height;
            
            // ã‚¯ãƒªã‚¢
            canvasCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

            if (results.poseLandmarks) {
                currentPose = results.poseLandmarks;
                
                // ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯æç”»
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {
                    color: '#00FF00', lineWidth: 4
                });
                drawLandmarks(canvasCtx, results.poseLandmarks, {
                    color: '#FF0000', lineWidth: 2
                });

                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è©•ä¾¡ï¼ˆã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ‰æ™‚ï¼‰
                if (isCamera) {
                    performRealtimeEvaluation(results.poseLandmarks);
                }
            }
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è©•ä¾¡
        function performRealtimeEvaluation(landmarks) {
            if (!landmarks || landmarks.length < 33) return;

            const handedness = document.getElementById('handedness').value;
            const shootingDirection = document.getElementById('shooting-direction').value;
            const clubType = document.getElementById('club-type').value;

            const evaluations = calculatePostureScores(landmarks, handedness, shootingDirection, clubType);
            
            if (evaluations) {
                displayRealtimeResults(evaluations);
            }
        }

        // å§¿å‹¢ã‚¹ã‚³ã‚¢è¨ˆç®—
        function calculatePostureScores(landmarks, handedness, shootingDirection, clubType) {
            try {
                const scores = {};
                
                // åŸºæœ¬çš„ãªè©•ä¾¡æŒ‡æ¨™
                if (shootingDirection === 'front') {
                    // æ­£é¢æ’®å½±æ™‚ã®è©•ä¾¡
                    scores.ballPosition = evaluateBallPosition(landmarks, clubType);
                    scores.stanceWidth = evaluateStanceWidth(landmarks);
                    scores.handPosition = evaluateHandPosition(landmarks);
                    scores.headPosition = evaluateHeadPosition(landmarks);
                } else {
                    // å¾Œæ–¹æ’®å½±æ™‚ã®è©•ä¾¡
                    scores.bodyAlignment = evaluateBodyAlignment(landmarks);
                    scores.forwardTilt = evaluateForwardTilt(landmarks, clubType);
                    scores.spinePosture = evaluateSpinePosture(landmarks);
                    scores.weightBalance = evaluateWeightBalance(landmarks);
                }

                return scores;
            } catch (error) {
                console.error('è©•ä¾¡è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }

        // å„ç¨®è©•ä¾¡é–¢æ•°ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function evaluateBallPosition(landmarks, clubType) {
            // è¶³é¦–é–“ã®ç›¸å¯¾ä½ç½®ã§è©•ä¾¡
            const leftAnkle = landmarks[27];
            const rightAnkle = landmarks[28];
            
            if (!leftAnkle || !rightAnkle) return 75;
            
            const footWidth = Math.abs(leftAnkle.x - rightAnkle.x);
            const centerX = (leftAnkle.x + rightAnkle.x) / 2;
            
            // ã‚¯ãƒ©ãƒ–åˆ¥ã®ç†æƒ³ä½ç½®ï¼ˆä»®ï¼‰
            const idealPositions = {
                'Driver': 0.3,
                '3W': 0.25,
                '7I': 0.0,
                'PW': -0.1,
                'SW': -0.15
            };
            
            const ideal = idealPositions[clubType] || 0;
            const score = Math.max(60, 100 - Math.abs(ideal * 200));
            
            return Math.round(score);
        }

        function evaluateStanceWidth(landmarks) {
            const leftAnkle = landmarks[27];
            const rightAnkle = landmarks[28];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            
            if (!leftAnkle || !rightAnkle || !leftShoulder || !rightShoulder) return 75;
            
            const stanceWidth = Math.abs(leftAnkle.x - rightAnkle.x);
            const shoulderWidth = Math.abs(leftShoulder.x - rightShoulder.x);
            
            const ratio = stanceWidth / shoulderWidth;
            const idealRatio = 1.2; // ç†æƒ³çš„ãªæ¯”ç‡
            
            const score = Math.max(60, 100 - Math.abs(ratio - idealRatio) * 100);
            return Math.round(score);
        }

        function evaluateHandPosition(landmarks) {
            const leftWrist = landmarks[15];
            const rightWrist = landmarks[16];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            
            if (!leftWrist || !rightWrist || !leftHip || !rightHip) return 75;
            
            const handCenterX = (leftWrist.x + rightWrist.x) / 2;
            const hipCenterX = (leftHip.x + rightHip.x) / 2;
            
            const deviation = Math.abs(handCenterX - hipCenterX);
            const score = Math.max(60, 100 - deviation * 500);
            
            return Math.round(score);
        }

        function evaluateHeadPosition(landmarks) {
            const nose = landmarks[0];
            const leftAnkle = landmarks[27];
            const rightAnkle = landmarks[28];
            
            if (!nose || !leftAnkle || !rightAnkle) return 75;
            
            const footCenterX = (leftAnkle.x + rightAnkle.x) / 2;
            const headDeviation = Math.abs(nose.x - footCenterX);
            
            const score = Math.max(60, 100 - headDeviation * 300);
            return Math.round(score);
        }

        function evaluateBodyAlignment(landmarks) {
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            
            if (!leftShoulder || !rightShoulder || !leftHip || !rightHip) return 75;
            
            const shoulderAngle = Math.atan2(leftShoulder.y - rightShoulder.y, leftShoulder.x - rightShoulder.x);
            const hipAngle = Math.atan2(leftHip.y - rightHip.y, leftHip.x - rightHip.x);
            
            const angleDiff = Math.abs(shoulderAngle - hipAngle);
            const score = Math.max(60, 100 - angleDiff * 100);
            
            return Math.round(score);
        }

        function evaluateForwardTilt(landmarks, clubType) {
            const leftShoulder = landmarks[11];
            const leftHip = landmarks[23];
            
            if (!leftShoulder || !leftHip) return 75;
            
            const tiltAngle = Math.atan2(leftShoulder.x - leftHip.x, leftHip.y - leftShoulder.y);
            const tiltDegrees = Math.abs(tiltAngle * 180 / Math.PI);
            
            // ã‚¯ãƒ©ãƒ–åˆ¥ç†æƒ³è§’åº¦
            const idealAngles = {
                'Driver': 30,
                '3W': 32,
                '7I': 35,
                'PW': 40,
                'SW': 42
            };
            
            const ideal = idealAngles[clubType] || 35;
            const score = Math.max(60, 100 - Math.abs(tiltDegrees - ideal) * 2);
            
            return Math.round(score);
        }

        function evaluateSpinePosture(landmarks) {
            const nose = landmarks[0];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            
            if (!nose || !leftShoulder || !rightShoulder || !leftHip || !rightHip) return 75;
            
            const shoulderCenter = {
                x: (leftShoulder.x + rightShoulder.x) / 2,
                y: (leftShoulder.y + rightShoulder.y) / 2
            };
            
            const hipCenter = {
                x: (leftHip.x + rightHip.x) / 2,
                y: (leftHip.y + rightHip.y) / 2
            };
            
            // èƒŒéª¨ã®æ›²ãŒã‚Šå…·åˆã‚’è©•ä¾¡
            const spineAlignment = Math.abs((nose.x - shoulderCenter.x) - (shoulderCenter.x - hipCenter.x));
            const score = Math.max(60, 100 - spineAlignment * 1000);
            
            return Math.round(score);
        }

        function evaluateWeightBalance(landmarks) {
            const leftAnkle = landmarks[27];
            const rightAnkle = landmarks[28];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            
            if (!leftAnkle || !rightAnkle || !leftHip || !rightHip) return 75;
            
            const footCenterX = (leftAnkle.x + rightAnkle.x) / 2;
            const hipCenterX = (leftHip.x + rightHip.x) / 2;
            
            const balance = Math.abs(footCenterX - hipCenterX);
            const score = Math.max(60, 100 - balance * 400);
            
            return Math.round(score);
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµæœè¡¨ç¤º
        function displayRealtimeResults(evaluations) {
            const scores = Object.values(evaluations);
            const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;
            
            // ç·åˆã‚¹ã‚³ã‚¢æ›´æ–°
            document.getElementById('total-score').textContent = Math.round(avgScore);
            
            // ã‚¹ã‚³ã‚¢çŠ¶æ…‹æ›´æ–°
            const statusElement = document.getElementById('score-status');
            if (avgScore >= 85) {
                statusElement.textContent = 'âœ… ç´ æ™´ã‚‰ã—ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼';
                statusElement.style.color = '#28a745';
            } else if (avgScore >= 70) {
                statusElement.textContent = 'âš ï¸ æ”¹å–„ã®ä½™åœ°ã‚ã‚Š';
                statusElement.style.color = '#ffc107';
            } else {
                statusElement.textContent = 'âŒ è¦æ”¹å–„';
                statusElement.style.color = '#dc3545';
            }
            
            // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
            updateRadarChart(evaluations);
            
            // è©³ç´°è©•ä¾¡æ›´æ–°
            updateDetailedEvaluation(evaluations);
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
        function updateProgress(percentage) {
            const progressBar = document.getElementById('progress-bar');
            const progressFill = document.getElementById('progress-fill');
            
            if (percentage > 0) {
                progressBar.style.display = 'block';
                progressFill.style.width = percentage + '%';
            } else {
                progressBar.style.display = 'none';
            }
        }

        // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        function uploadImage() {
            document.getElementById('file-input').click();
        }

        // ã‚«ãƒ¡ãƒ©èµ·å‹•
        async function startCamera() {
            try {
                if (!pose) {
                    showStatus('âŒ MediaPipeãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                    return;
                }

                const videoElement = document.getElementById('video-element');
                const videoContainer = document.getElementById('video-container');
                const canvasContainer = document.getElementById('canvas-container');
                
                // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾—
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 }
                });
                
                videoElement.srcObject = stream;
                videoContainer.style.display = 'block';
                canvasContainer.style.display = 'none';
                
                // ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ‰è¨­å®š
                isCamera = true;
                isProcessing = true;
                
                // ãƒœã‚¿ãƒ³åˆ‡ã‚Šæ›¿ãˆ
                document.getElementById('analyze-btn').style.display = 'none';
                document.getElementById('capture-btn').style.display = 'inline-block';
                
                // MediaPipeã«ã‚«ãƒ¡ãƒ©ã‚’æ¥ç¶š
                camera = new Camera(videoElement, {
                    onFrame: async () => {
                        if (pose && isProcessing) {
                            await pose.send({ image: videoElement });
                        }
                    },
                    width: 640,
                    height: 480
                });
                
                camera.start();
                showStatus('ğŸ“¹ ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ºæ–­ä¸­...', 'success');
                
            } catch (error) {
                console.error('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('âŒ ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ•ãƒ¬ãƒ¼ãƒ å–å¾—
        function captureFrame() {
            const videoElement = document.getElementById('video-element');
            const canvas = document.getElementById('video-canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            
            ctx.drawImage(videoElement, 0, 0);
            
            // ç”»åƒã¨ã—ã¦ä¿å­˜
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'golf_address_capture.jpg';
                a.click();
                URL.revokeObjectURL(url);
            });
            
            showStatus('ğŸ“¸ ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¾ã—ãŸ', 'success');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
        document.getElementById('file-input').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        const uploadSection = document.getElementById('upload-section');

        uploadSection.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadSection.classList.add('drag-over');
        });

        uploadSection.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadSection.classList.remove('drag-over');
        });

        uploadSection.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadSection.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showStatus('âŒ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showStatus('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ10MBä»¥ä¸‹ï¼‰', 'error');
                return;
            }

            showStatus('ğŸ“¤ ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...', 'info');
            
            // ã‚«ãƒ¡ãƒ©åœæ­¢
            stopCamera();

            const reader = new FileReader();
            reader.onload = function(e) {
                currentImage = e.target.result;
                displayImage(currentImage);
                showStatus('âœ… ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
                document.getElementById('analyze-btn').disabled = false;
            };

            reader.onerror = function() {
                showStatus('âŒ ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            };

            reader.readAsDataURL(file);
        }

        // ç”»åƒè¡¨ç¤º
        function displayImage(imageSrc) {
            const canvas = document.getElementById('main-canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                const maxWidth = 600;
                const maxHeight = 400;
                let { width, height } = img;
                
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                if (height > maxHeight) {
                    width = (width * maxHeight) / height;
                    height = maxHeight;
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                document.getElementById('canvas-container').style.display = 'block';
                document.getElementById('video-container').style.display = 'none';
            };
            
            img.src = imageSrc;
        }

        // AIè¨ºæ–­
        async function analyzeImage() {
            if (!currentImage || !pose) {
                showStatus('âŒ ç”»åƒã¨MediaPipeãŒå¿…è¦ã§ã™', 'error');
                return;
            }

            showStatus('ğŸ¤– AIè¨ºæ–­ã‚’å®Ÿè¡Œä¸­...', 'info');
            updateProgress(25);
            
            try {
                isProcessing = true;
                
                // ç”»åƒã‚’MediaPipeã«é€ä¿¡
                const img = new Image();
                img.onload = async function() {
                    updateProgress(50);
                    await pose.send({ image: img });
                    updateProgress(75);
                    
                    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰çµæœã‚’å‡¦ç†
                    setTimeout(() => {
                        if (currentPose) {
                            processAnalysisResults();
                        } else {
                            showStatus('âŒ å§¿å‹¢ãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ', 'error');
                        }
                        updateProgress(0);
                        isProcessing = false;
                    }, 1000);
                };
                img.src = currentImage;
                
            } catch (error) {
                console.error('åˆ†æã‚¨ãƒ©ãƒ¼:', error);
                showStatus('âŒ åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                updateProgress(0);
                isProcessing = false;
            }
        }

        // åˆ†æçµæœå‡¦ç†
        function processAnalysisResults() {
            if (!currentPose) return;
            
            const handedness = document.getElementById('handedness').value;
            const shootingDirection = document.getElementById('shooting-direction').value;
            const clubType = document.getElementById('club-type').value;
            
            const evaluations = calculatePostureScores(currentPose, handedness, shootingDirection, clubType);
            
            if (evaluations) {
                displayResults(evaluations);
                showStatus('âœ… AIè¨ºæ–­ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
            } else {
                showStatus('âŒ è©•ä¾¡ã®è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // çµæœè¡¨ç¤º
        function displayResults(evaluations) {
            displayRealtimeResults(evaluations);
        }

        // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
        function updateRadarChart(evaluations) {
            const ctx = document.getElementById('radar-chart').getContext('2d');
            
            const labels = Object.keys(evaluations).map(key => {
                const labelMap = {
                    ballPosition: 'ãƒœãƒ¼ãƒ«ä½ç½®',
                    stanceWidth: 'ã‚¹ã‚¿ãƒ³ã‚¹å¹…',
                    handPosition: 'æ‰‹ã®ä½ç½®',
                    headPosition: 'é ­ã®ä½ç½®',
                    bodyAlignment: 'ä½“ã®å‘ã',
                    forwardTilt: 'å‰å‚¾è§’åº¦',
                    spinePosture: 'èƒŒç­‹å§¿å‹¢',
                    weightBalance: 'é‡å¿ƒãƒãƒ©ãƒ³ã‚¹'
                };
                return labelMap[key] || key;
            });
            
            const data = Object.values(evaluations);
            
            if (radarChart) {
                radarChart.destroy();
            }
            
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ã‚¹ã‚³ã‚¢',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(102, 126, 234, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            min: 0,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // è©³ç´°è©•ä¾¡æ›´æ–°
        function updateDetailedEvaluation(evaluations) {
            const container = document.getElementById('evaluation-results');
            container.innerHTML = '';
            
            Object.entries(evaluations).forEach(([key, score]) => {
                const labelMap = {
                    ballPosition: 'ãƒœãƒ¼ãƒ«ä½ç½®',
                    stanceWidth: 'ã‚¹ã‚¿ãƒ³ã‚¹å¹…',
                    handPosition: 'æ‰‹ã®ä½ç½®',
                    headPosition: 'é ­ã®ä½ç½®',
                    bodyAlignment: 'ä½“ã®å‘ã',
                    forwardTilt: 'å‰å‚¾è§’åº¦',
                    spinePosture: 'èƒŒç­‹å§¿å‹¢',
                    weightBalance: 'é‡å¿ƒãƒãƒ©ãƒ³ã‚¹'
                };
                
                const commentMap = {
                    ballPosition: 'ã‚¯ãƒ©ãƒ–ã«é©ã—ãŸãƒœãƒ¼ãƒ«ä½ç½®ã§ã™',
                    stanceWidth: 'è‚©å¹…ã«å¯¾ã—ã¦é©åˆ‡ãªã‚¹ã‚¿ãƒ³ã‚¹å¹…ã§ã™',
                    handPosition: 'æ‰‹ã®ä½ç½®ã¯è‰¯å¥½ã§ã™',
                    headPosition: 'é ­ã®ä½ç½®ã¯é©åˆ‡ã§ã™',
                    bodyAlignment: 'ä½“ã®å‘ãã¯æƒã£ã¦ã„ã¾ã™',
                    forwardTilt: 'å‰å‚¾è§’åº¦ã¯é©åˆ‡ã§ã™',
                    spinePosture: 'èƒŒç­‹ã¯é©åˆ‡ã«ä¿ãŸã‚Œã¦ã„ã¾ã™',
                    weightBalance: 'é‡å¿ƒãƒãƒ©ãƒ³ã‚¹ã¯è‰¯å¥½ã§ã™'
                };
                
                const label = labelMap[key] || key;
                const comment = commentMap[key] || 'è©•ä¾¡ä¸­...';
                
                let scoreClass = 'score-excellent';
                if (score < 85) scoreClass = 'score-good';
                if (score < 70) scoreClass = 'score-poor';
                
                const item = document.createElement('div');
                item.className = 'evaluation-item';
                item.innerHTML = `
                    <h4>${label}</h4>
                    <div class="evaluation-score ${scoreClass}">${score}ç‚¹</div>
                    <p>${comment}</p>
                `;
                
                container.appendChild(item);
            });
        }

        // ã‚«ãƒ¡ãƒ©åœæ­¢
        function stopCamera() {
            if (camera) {
                camera.stop();
                camera = null;
            }
            
            const videoElement = document.getElementById('video-element');
            if (videoElement.srcObject) {
                const tracks = videoElement.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                videoElement.srcObject = null;
            }
            
            isCamera = false;
            isProcessing = false;
            
            document.getElementById('video-container').style.display = 'none';
            document.getElementById('analyze-btn').style.display = 'inline-block';
            document.getElementById('capture-btn').style.display = 'none';
        }

        // å…¨ã‚¯ãƒªã‚¢
        function clearAll() {
            stopCamera();
            
            currentImage = null;
            currentPose = null;
            
            document.getElementById('file-input').value = '';
            document.getElementById('canvas-container').style.display = 'none';
            document.getElementById('analyze-btn').disabled = true;
            
            // ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('total-score').textContent = '--';
            document.getElementById('score-status').textContent = 'ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„';
            document.getElementById('score-status').style.color = '#666';
            
            // ãƒãƒ£ãƒ¼ãƒˆã‚¯ãƒªã‚¢
            if (radarChart) {
                radarChart.destroy();
                radarChart = null;
            }
            
            // è©•ä¾¡çµæœãƒªã‚»ãƒƒãƒˆ
            const container = document.getElementById('evaluation-results');
            container.innerHTML = `
                <div class="evaluation-item">
                    <h4>ãƒœãƒ¼ãƒ«ä½ç½®</h4>
                    <div class="evaluation-score score-excellent">--ç‚¹</div>
                    <p>ç”»åƒã‚’è§£æã—ã¦ãã ã•ã„</p>
                </div>
                <div class="evaluation-item">
                    <h4>ã‚¹ã‚¿ãƒ³ã‚¹å¹…</h4>
                    <div class="evaluation-score score-excellent">--ç‚¹</div>
                    <p>ç”»åƒã‚’è§£æã—ã¦ãã ã•ã„</p>
                </div>
                <div class="evaluation-item">
                    <h4>å§¿å‹¢ãƒãƒ©ãƒ³ã‚¹</h4>
                    <div class="evaluation-score score-excellent">--ç‚¹</div>
                    <p>ç”»åƒã‚’è§£æã—ã¦ãã ã•ã„</p>
                </div>
                <div class="evaluation-item">
                    <h4>ä½“ã®å‘ã</h4>
                    <div class="evaluation-score score-excellent">--ç‚¹</div>
                    <p>ç”»åƒã‚’è§£æã—ã¦ãã ã•ã„</p>
                </div>
            `;
            
            showStatus('ğŸ—‘ï¸ ã™ã¹ã¦ã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ', 'info');
        }

        // åˆæœŸåŒ–
        window.onload = function() {
            console.log('ã‚´ãƒ«ãƒ•ã‚¢ãƒ‰ãƒ¬ã‚¹è¨ºæ–­ãƒ„ãƒ¼ãƒ«ï¼ˆMediaPipeç‰ˆï¼‰åˆæœŸåŒ–é–‹å§‹');
            
            // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–
            const ctx = document.getElementById('radar-chart').getContext('2d');
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['ãƒœãƒ¼ãƒ«ä½ç½®', 'ã‚¹ã‚¿ãƒ³ã‚¹å¹…', 'å§¿å‹¢ãƒãƒ©ãƒ³ã‚¹', 'ä½“ã®å‘ã'],
                    datasets: [{
                        label: 'ã‚¹ã‚³ã‚¢',
                        data: [0, 0, 0, 0],
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            min: 0,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            // MediaPipeåˆæœŸåŒ–
            initializeMediaPipe();
        };
    </script>
</body>
</html>
